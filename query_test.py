# ============================================================
# query_test.py
#
# ì´ íŒŒì¼ì˜ ì—­í• 
# ------------------------------------------------------------
# âœ” ì´ë¯¸ ì €ì¥ëœ Chroma ë²¡í„°DBë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤
# âœ” ì§ˆë¬¸ì„ í•˜ë‚˜ ì…ë ¥ë°›ëŠ”ë‹¤
# âœ” ë²¡í„°DBì—ì„œ ì§ˆë¬¸ê³¼ ê°€ì¥ ìœ ì‚¬í•œ ë¬¸ì„œ(chunk)ë¥¼ ê²€ìƒ‰í•œë‹¤
# âœ” ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•œë‹¤
#
# ì¦‰,
# ğŸ‘‰ "RAGì˜ ê²€ìƒ‰(Retrieval) ë‹¨ê³„ë§Œ ë‹¨ë…ìœ¼ë¡œ í…ŒìŠ¤íŠ¸"í•˜ëŠ” íŒŒì¼
#
# ì‹¤í–‰:
#   python query_test.py
# ============================================================

"""
python query_test.py
 â†“
ë²¡í„°DB ë¡œë“œ
 â†“
ì§ˆë¬¸ ì…ë ¥
 â†“
ì§ˆë¬¸ì„ ë²¡í„°ë¡œ ë³€í™˜
 â†“
ë²¡í„°DBì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ë¬¸ì„œ ê²€ìƒ‰
 â†“
ê²€ìƒ‰ ê²°ê³¼ ì¶œë ¥
"""

# ----------------------------
# LangChain ê´€ë ¨ ì»´í¬ë„ŒíŠ¸
# ----------------------------

# OpenAIEmbeddings:
# - ì§ˆë¬¸ í…ìŠ¤íŠ¸ë¥¼ ë²¡í„°ë¡œ ë³€í™˜í•˜ê¸° ìœ„í•´ í•„ìš”
from langchain_openai import OpenAIEmbeddings

# Chroma:
# - ë¡œì»¬ì— ì €ì¥ëœ ë²¡í„°DBë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í´ë˜ìŠ¤
from langchain_chroma import Chroma


# ----------------------------
# í”„ë¡œì íŠ¸ ì„¤ì •ê°’
# ----------------------------

# config.pyì— ëª¨ì•„ë‘” ì„¤ì •
from config import (
    EMBED_MODEL,       # ì„ë² ë”© ëª¨ë¸ ì´ë¦„
    OPENAI_API_KEY,    # í…ŒìŠ¤íŠ¸ìš© OpenAI API í‚¤
)


# ----------------------------
# ë²¡í„°DB ì„¤ì •
# ----------------------------

# ë²¡í„°DBê°€ ì‹¤ì œë¡œ ì €ì¥ëœ ë””ë ‰í† ë¦¬
CHROMA_DIR = "./chroma_db"

# ingest ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•œ ì»¬ë ‰ì…˜ ì´ë¦„ê³¼ ë°˜ë“œì‹œ ê°™ì•„ì•¼ í•¨
COLLECTION_NAME = "my_rag_docs"


# ============================================================
# ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
# ============================================================
def main():
    """
    query_test.py ì‹¤í–‰ ì‹œ
    ì´ í•¨ìˆ˜ë¶€í„° ì‹œì‘ëœë‹¤
    """

    # ----------------------------
    # 1) ì„ë² ë”© ê°ì²´ ìƒì„±
    # ----------------------------
    # ì§ˆë¬¸ì„ ë²¡í„°ë¡œ ë°”ê¾¸ëŠ” ë° ì‚¬ìš©
    # ingest ë‹¨ê³„ì™€ ê°™ì€ ëª¨ë¸ì„ ì¨ì•¼ í•¨
    embeddings = OpenAIEmbeddings(
        model=EMBED_MODEL,
        api_key=OPENAI_API_KEY
    )


    # ----------------------------
    # 2) ë²¡í„°DB ë¡œë“œ
    # ----------------------------
    # persist_directoryì— ì €ì¥ëœ DBë¥¼ ê·¸ëŒ€ë¡œ ë¶ˆëŸ¬ì˜¨ë‹¤
    db = Chroma(
        collection_name=COLLECTION_NAME,
        embedding_function=embeddings,
        persist_directory=CHROMA_DIR,
    )


    # ----------------------------
    # 3) ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥
    # ----------------------------
    # ì½˜ì†”ì—ì„œ ì§ˆë¬¸ì„ ì§ì ‘ ì…ë ¥
    q = input("ì§ˆë¬¸> ").strip()


    # ----------------------------
    # 4) ìœ ì‚¬ ë¬¸ì„œ ê²€ìƒ‰
    # ----------------------------
    # similarity_search:
    # - ì§ˆë¬¸ì„ ë²¡í„°ë¡œ ë³€í™˜
    # - ë²¡í„°DBì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ë¬¸ì„œ ê²€ìƒ‰
    # - ì—¬ê¸°ì„œëŠ” ìƒìœ„ 4ê°œ(k=4)
    docs = db.similarity_search(q, k=4)


    # ----------------------------
    # 5) ê²°ê³¼ ì¶œë ¥
    # ----------------------------
    print("\n--- TOP MATCHES ---")

    for i, d in enumerate(docs, start=1):
        # metadataì— ì €ì¥ëœ ë¬¸ì„œ ì¶œì²˜
        print(f"\n[{i}] source={d.metadata.get('source')}")

        # ë¬¸ì„œ ë‚´ìš© ì¼ë¶€ë§Œ ì¶œë ¥ (ë„ˆë¬´ ê¸¸ë©´ ë³´ê¸° í˜ë“œë‹ˆê¹Œ)
        print(d.page_content[:400])


# ============================================================
# íŒŒì´ì¬ íŒŒì¼ ì§ì ‘ ì‹¤í–‰ ì‹œ ì‹œì‘ ì§€ì 
# ============================================================
if __name__ == "__main__":
    main()
